<!DOCTYPE html>
<html lang="zh-CN">
<author name="KoiNL, 锦鲤未离">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>读 TXT 文件-作者：锦鲤未离</title>
        <style>
            body {
                display: flex;
                justify-content: space-between;
                height: 100%;
                margin: 0;
                padding: 0;
                background-color: #faebd7;
            }

            .hidden {
                display: none;
            }

            pre {
                font-family: inherit;
                white-space: pre-wrap;
                tab-size: 2;
            }

            button {
                border: none;
                outline: none;
                background: none;
                cursor: pointer;
                border: 1px solid orange;
                border-radius: 20px;
                padding: 8px 16px;
                color: orange;
                font-size: 13px;
            }

            button:hover {
                background-color: #ffa500;
                color: #ffffff;
                border-color: orange;
            }

            #folderInput {
                width: 0%;
                opacity: 0;
                position: absolute;
                z-index: -1;
            }

            #folderInput+label {
                display: inline-block;
                border: 1px solid orange;
                border-radius: 20px;
                padding: 8px 16px;
                color: orange;
                font-size: 13px;
                cursor: pointer;
            }

            #folderInput+label:hover {
                background-color: #ffa500;
                color: #ffffff;
                border-color: orange;
            }

            /* 左容器 */
            #fileListContainer {
                min-width: 23%;
                max-width: 45%;
                position: fixed;
                top: 0;
                left: 0;
                bottom: 0;
                padding: 10px;
                box-sizing: border-box;
                background: #faebd7ed;
                overflow: auto;
                scrollbar-width: none;
                /* 对Firefox有效 */
                -ms-overflow-style: none;
                /* 对IE和Edge有效 */

            }

            #fileListContainer::-webkit-scrollbar {
                display: none;
                /* 对Chrome, Safari, 和Opera有效 */
            }

            #fileContent h2 {
                margin-top: 60px;
            }

            /* 右容器 */
            #fileContentContainer {
                display: flex;
                flex-direction: column;
                flex: 1;
                overflow-y: auto;
                box-sizing: border-box;
            }

            /* 右容器·上方小工具 */
            #topControls {
                position: fixed;
                top: 10px;
                left: 50%;
                transform: translateX(-50%);
            }

            /* 滑动条 */
            #fontSizeRangediv {
                display: inline-block;
            }

            /* range输入的样式 */
            #fontSizeRangediv input[type="range"] {
                -webkit-appearance: none;
                appearance: none;
                width: 100%;
                height: 10px;
                background: #ffa500;
                border-radius: 5px;
                outline: none;
                margin: 10px 0;
            }

            /* 文件列表 */
            #fileList {
                display: flex;
                flex-wrap: wrap;
                width: 65%;
                margin: 0 auto;
                justify-content: center;
                margin-top: 10px;
            }

            /* 每一个文件列表小块 */
            #fileList div {
                padding: 0 5px 0 5px;
            }

            #fileList div:hover {
                padding: 0 3.7px 0 3.7px;
            }

            #fileList.hidden,
            #fileContent.hidden {
                display: none;
            }

            /* 章节目录 */
            .chapter-link {
                display: block;
            }

            #fileList div a,
            #chapterLinks a {
                display: block;
                text-decoration: none;
                color: #b24224;
                padding-bottom: 5px;
                padding-top: 5px;
            }

            #fileList div a:hover, #fileListContainer div a:hover {
                font-weight: bold;
            }

            /* 文件正文 */
            #fileContent {
                font-size: 20px;
                margin: 0 27px 0 27px;
                overflow-y: auto;
            }

            /* 暗色模式样式 */
            .dark-mode {
                background-color: #000000;
            }

            .dark-mode #fileListContainer {
                background-color: #000000ed;
            }

            .dark-mode button,
            .dark-mode #folderInput+label {
                border: 1px solid #ffa50090;
                color: #ffa50090;
            }

            .dark-mode button:hover,
            .dark-mode #folderInput+label:hover {
                background-color: #ffa50090;
                color: #ffffff90;
                border-color: #ffa50090;
            }

            .dark-mode #fileList div a,
            .dark-mode #chapterLinks a {
                color: #b2422490;
            }

            .dark-mode #fileContentContainer,
            .dark-mode #chapterLinks h1 {
                color: #ffffff90;
            }

            .dark-mode #fontSizeRangediv input[type="range"] {
                background: #ffa50080;
            }

            @media (min-width: 0px) {
                #fileContent {
                    padding: 120px 10px;
                }

                #fileList {
                    width: 90%;
                }
            }

            @media (min-width: 768px) {
                #fileContent {
                    padding: 60px 100px;
                }

                #fileList {
                    width: 80%;
                }
            }

            @media (min-width: 1024px) {
                #fileContent {
                    padding: 30px 180px;
                }

                #fileList {
                    width: 70%;
                }
            }

            @media (min-width: 1440px) {
                #fileContent {
                    padding: 15px 310px;
                }

                #fileList {
                    width: 65%;
                }
            }
        </style>
    </head>

    <body id="body">
        <!-- 0A·左容器（文章目录容器） -->
        <div id="fileListContainer" style="display: none;">
            <!-- 04文章目录 -->
            <div id="chapterLinks"></div>
        </div>
        <!-- 0B·右文件内容容器 -->
        <div id="fileContentContainer">
            <!-- 小工具容器 -->
            <div id="topControls">
                <!-- 暗色 -->
                <button id="toggleDarkModeBtn">切换暗色(D)</button>
                <!-- 01选择文件的输入框 -->
                <input type="file" id="folderInput" webkitdirectory directory multiple />
                <label for="folderInput" id="folderInputLabel">选择书库(Enter)</label>
                <!-- 重置界面 -->
                <button id="fileReselect">重置界面(R)</button>
                <!-- 新增显隐目录按钮 -->
                <button id="toggleChapterLinksBtn" style="display: none;">章节目录(L)</button>
                <!-- 02返回文件列表的按钮 -->
                <button id="backToListBtn" style="display: none;">返回书库(Alt)</button>
                <!-- 调整字体大小 -->
                <div id="fontSizeRangediv" style="display: none;">
                    <input type="range" id="fontSizeRange" min="10" max="30" value="20" step="1">
                </div>
            </div>
            <!-- 03文件列表容器 -->
            <div id="fileList"></div>
            <!-- 文章正文 -->
            <pre id="fileContent" class="hidden"></pre>
        </div>



        <script>
            // 正则表达式
            var zzbds = '[　 第]*[零一二三四五六七八九十百千 至到0-9]+[章篇卷梦].*?|\\n番外\\d*.*?|\\n[　 ]*[0-9]+[．、.].*?';
            var chapterPattern = new RegExp(`(${zzbds}|\\n)(?=\\n${zzbds}|\\n?$)`, 'gs');
            var introMatching = new RegExp(`[\\s\\S]*?(?=${zzbds})`);


            // 核心模块1a：选择文件夹后出现“文件列表”
            document.getElementById('folderInput').addEventListener('change', function (e) {
                var files = e.target.files;// 获取选择的文件列表
                var fileListDiv = document.getElementById('fileList');// 获取文件列表容器元素
                fileListDiv.innerHTML = "";// 清空文件列表容器
                // 遍历文件列表
                for (var i = 0; i < files.length; i++) {
                    var file = files[i];
                    if (file.name.endsWith('.txt')) { // 需要满足条件
                        var listItem = document.createElement('div');// 创建文件列表项容器
                        var link = document.createElement('a');// 创建文件列表项链接
                        link.textContent = file.name.split('.').slice(0, -1).join('.'); // 获取文件名（去除扩展名）
                        link.href = "#"; // 使用 # 暂时占位，实际需要点击时处理

                        // 若进行点击，会进行什么操作？
                        link.addEventListener('click', function (file) {
                            return function () {
                                readFileContent(file);// 读取文件内容
                                hideFileList();// 隐藏文件列表
                                showButton();// 显示多个按钮
                            };
                        }(file));
                        listItem.appendChild(link);// 将链接添加到列表项容器中
                        fileListDiv.appendChild(listItem);// 将列表项容器添加到文件列表容器中
                    }
                }
            });

            // 1a➡b：隐藏文件列表
            function hideFileList() {
                document.getElementById('fileList').classList.add('hidden');// 添加隐藏样式
                document.getElementById('folderInputLabel').style.display = 'none';// 隐藏文件夹操作
            }
            // 1a➡c：显示什么按钮？
            function showButton() {
                document.getElementById('backToListBtn').style.display = '';// 显示返回按钮
                document.getElementById('toggleChapterLinksBtn').style.display = '';// 显示章节目录按钮
                document.getElementById('fontSizeRangediv').style.display = ''; //设置字体大小
            }

            // 1a➡a：文件内容读取
            var MaxcurrentChapterIndex = 0;    // 文件最大章节数
            function readFileContent(file) {
                var reader = new FileReader(); // 创建文件阅读器对象
                reader.onload = function (e) {
                    // 获取+重置章节链接+正文内容
                    var contents = e.target.result; // 获取文件内容

                    var fileContent = document.getElementById('fileContent'); // 获取文件内容容器
                    fileContent.innerHTML = ""; // 清空文件内容容器
                    // 清除之前的章节链接
                    var chapterLinksDiv = document.getElementById('chapterLinks');
                    chapterLinksDiv.innerHTML = "";

                    // 正文内容操作1：第一章前面的内容加到正文顶部
                    var introMatch = contents.match(introMatching);
                    var introContent = introMatch ? introMatch[0] : '';
                    if (introContent) {
                        var introElement = document.createElement('pre');
                        introElement.innerHTML = introContent.replace(/\n/g, '<br>');
                        fileContent.appendChild(introElement);
                    }
                    // 章节链接操作1：获取文件名并作为书名显示在章节目录顶部
                    var bookTitleElement = document.createElement('h1'); // 创建标题元素
                    bookTitleElement.textContent = file.name.split('.').slice(0, -1).join('.'); // 获取文件名（去除扩展名）
                    chapterLinksDiv.appendChild(bookTitleElement); // 将标题元素添加到章节链接容器中

                    // 处理文章内容，提取章节并生成链接
                    var matches; // 存储匹配结果
                    var index = 1; // 章节索引，用于生成锚点和链接
                    chapterPattern.lastIndex = 0; // 重置正则表达式的 lastIndex
                    while ((matches = chapterPattern.exec(contents)) !== null) {
                        var chapterContent = matches[0].trim(); // 提取章节内容
                        var chapterTitle = chapterContent.split('\n')[0].trim(); // 提取章节标题

                        // 章节目录操作2：创建章节目录
                        var chapterLink = document.createElement('a');
                        chapterLink.textContent = chapterTitle; // 仅显示标题行作为链接文本
                        chapterLink.href = "#chapter" + index; // 设置链接的锚点
                        chapterLink.className = 'chapter-link'; // 添加类名
                        chapterLinksDiv.appendChild(chapterLink); // 将链接添加到章节链接容器中

                        // 正文内容操作2：在正文中创建章节内容（锚点），这样当点击章节目录就会跳转到此处
                        var chapterAnchor = document.createElement('a');
                        chapterAnchor.name = "chapter" + index; // 设置锚点名称
                        fileContent.appendChild(chapterAnchor); // 将锚点添加到文件内容容器中

                        // 正文内容操作3：创建章节标题
                        var chapterHeader = document.createElement('h2');
                        chapterHeader.textContent = chapterTitle; // 仅显示标题行作为章节标题
                        fileContent.appendChild(chapterHeader); // 将标题添加到文件内容容器中

                        // 正文内容操作4：创建章节内容段落
                        var chapterParagraph = document.createElement('pre');
                        chapterParagraph.textContent = chapterContent; // 设置段落内容
                        fileContent.appendChild(chapterParagraph); // 将段落添加到文件内容容器中

                        index++; // 增加章节索引，用于下一个章节
                        MaxcurrentChapterIndex = index;//确定文件最大章节数
                    }

                    fileContent.classList.remove('hidden'); // 移除文件内容隐藏样式
                };
                reader.readAsText(file); // 以文本格式读取文件
            }


            // 1.按钮功能模块：选择文件夹按钮 文件选择完毕后更名重选按钮
            document.getElementById('folderInput').addEventListener('change', function (evt) {
                document.getElementById('folderInputLabel').textContent = '重选书库(Enter)';
            });

            // 2.按钮功能模块：重置页面 点击“重置页面”按钮时，刷新页面
            document.getElementById('fileReselect').addEventListener('click', function () {
                location.reload();
            });

            // 3.按钮功能模块：显示/隐藏文章目录按钮，主要是为快捷键服务呢，我知道和屏幕上点按外部区域冲突了。
            document.getElementById('toggleChapterLinksBtn').addEventListener('click', function () {
                document.getElementById('fileListContainer').classList.toggle('hidden'); // 切换隐藏/显示章节链接容器
            });

            // 4.按钮功能模块：
            document.getElementById('toggleDarkModeBtn').addEventListener('click', function () {
                // 切换暗色模式
                document.body.classList.toggle('dark-mode');
            });
            // 5.按钮功能模块：滑动按钮来设置字体大小
            // 获取 font size range 元素和 fileContent 元素
            var fontSizeRange = document.getElementById('fontSizeRange');
            var fileContent = document.getElementById('fileContent');
            // 监听 font size range 元素的 input 事件
            fontSizeRange.addEventListener('input', function () {
                // 设置 fileContent 元素的字体大小
                fileContent.style.fontSize = fontSizeRange.value + 'px';
            });


            // 6.按钮功能模块：点按返回文章列表按钮
            document.getElementById('backToListBtn').addEventListener('click', function () {
                document.getElementById('fileList').classList.remove('hidden');// 移除文件列表的隐藏样式
                fileListContainer.style.display = 'none'; // 隐藏文章目录容器
                document.getElementById('fileContent').classList.add('hidden');// 添加文章内容的隐藏样式
                document.getElementById('chapterLinks').innerHTML = ''; // 清除文章目录
                document.getElementById('fileContent').innerHTML = ''; // 清除文件内容
                document.getElementById('backToListBtn').style.display = 'none';// 隐藏返回按钮
                document.getElementById('toggleChapterLinksBtn').style.display = 'none';// 隐藏章节目录按钮
                document.getElementById('fontSizeRangediv').style.display = 'none';//隐藏设置字体大小按钮
                document.getElementById('folderInputLabel').style.display = '';// 显示重选按钮
            });

            // 美化模块：确保fileList、fileContent不会被topControls覆盖
            document.addEventListener('DOMContentLoaded', function () {
                topControlsOffsetHeight = document.getElementById('topControls').offsetHeight + 30 + 'px';
                document.getElementById('fileList').style.marginTop = topControlsOffsetHeight; // 将topControls的高度应用为fileList的顶部边距
                document.getElementById('fileContent').style.marginTop = topControlsOffsetHeight; // 将topControls的高度应用为fileContent的顶部边距
            });


            // 便捷模块：点击在章节目录容器外等，就当按下了显隐正文目录按钮
            document.addEventListener('click', function (event) {
                var fileListContainer = document.getElementById('fileListContainer'); // 获取章节链接容器
                var isClickInsidefileListContainer = fileListContainer.contains(event.target); // 检查点击位置是否在章节链接容器内
                var isClickInsidetoggleDarkModeBtn = toggleDarkModeBtn.contains(event.target); // 检查点击位置是否在设置字体大小容器内
                var isClickInsidefontSizeRangediv = fontSizeRangediv.contains(event.target); // 检查点击位置是否在暗色模式（与上注释颠倒）容器内
                if (!isClickInsidefileListContainer && !isClickInsidetoggleDarkModeBtn && !isClickInsidefontSizeRangediv && fileList.classList.contains('hidden')) { // 如果点击位置不在章节链接容器内并且文件列表的类名为“隐藏”（点击正文后文件列表就会隐藏嘛，取了个巧）
                    if (fileListContainer.style.display === 'none' || fileListContainer.style.display === '') {
                        fileListContainer.style.display = 'block'; // 显示章节目录容器
                    } else {
                        fileListContainer.style.display = 'none'; // 隐藏章节目录容器
                    }
                }
            });

            // 便捷模块：键盘左右键跳转上下章。这个为处理键盘事件的函数
            function handleKeyboardEvent(event) {
                if (event.keyCode === 39 || event.keyCode === 37) { // 如果按下的是右箭头键或者左箭头键
                    event.preventDefault(); // 阻止默认事件，以避免浏览器默认的滚动行为
                    var currentHash = window.location.hash; // 获取当前页面的 hash 值
                    var currentChapter;//获取当前页面章节号
                    if (currentHash.startsWith("#chapter")) { // 假设格式是"#chapterX"
                        currentChapter = parseInt(currentHash.substring(8)); // 截取“X”
                    } else {
                        currentChapter = 1;
                    }
                    // 计算下一章或上一章的章节号
                    var nextChapter;
                    if (event.keyCode === 39) { // 右箭头键，下一页
                        nextChapter = Math.min(currentChapter + 1, MaxcurrentChapterIndex - 1);
                    } else if (event.keyCode === 37) { // 左箭头键，上一页
                        nextChapter = Math.max(currentChapter - 1, 1);
                    }
                    var nextChapterAnchor = '#chapter' + nextChapter; // 构建下一章或上一章的锚点
                    location.hash = nextChapterAnchor; // 将页面滚动到下一章或上一章的位置
                }
            }
            document.addEventListener('keydown', handleKeyboardEvent);// 监听键盘事件


            // 便捷模块：当按下 Alt 键，跳转到文章列表
            document.addEventListener('keydown', function (event) {
                if (event.altKey) {
                    document.getElementById('backToListBtn').click();// 触发返回按钮的点击事件
                }
            });

            // 便捷模块：当按下回车 Enter 键，就当点击了一开始那个按钮
            document.addEventListener('keydown', function (event) {
                if (folderInputLabel.style.display !== 'none') { // 只有当有选择文件夹按钮的时候，才可以进行这个操作，其他的为什么没有嘛...嘿嘿，也是取巧
                    if (event.key === "Enter") {
                        document.getElementById('folderInput').click();
                    }
                }
            });

            // 便捷模块：当按下 D 键，就当点击了暗色模式
            document.addEventListener('keydown', function (event) {
                if (event.keyCode === 68) {
                    document.getElementById('toggleDarkModeBtn').click();
                }
            });

            // 便捷模块：当按下 R 键，就当点击了重置界面
            document.addEventListener('keydown', function (event) {
                if (event.keyCode === 82) {
                    document.getElementById('fileReselect').click();
                }
            });
            // 便捷模块 L 显示隐藏章节目录
            document.addEventListener('keydown', function (event) {
                if (event.keyCode === 76) { //L
                    document.getElementById('toggleChapterLinksBtn').click();
                }
            });


        </script>

        <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
        <script type="text/javascript">
            var chartkoinl = document.createElement('div');
            chartkoinl.setAttribute('id', 'main4');
            chartkoinl.style.width = '80px';
            chartkoinl.style.height = '48px';
            chartkoinl.style.position = 'fixed';
            chartkoinl.style.top = '5px';
            chartkoinl.style.right = '6px';
            body.appendChild(chartkoinl); // 将标题元素添加到章节链接容器中
            var koinlChart = echarts.init(chartkoinl);
            var option;
            option = {
                graphic: {    //图形元素配置对象。
                    elements: [    //元素数组，包含了要添加到图形中的元素。
                        {
                            type: 'text',
                            left: 'center',
                            top: 'center',
                            style: {
                                text: '锦鲤未离',
                                fontFamily: 'STSong',
                                fontSize: 20,    // 大小
                                fontWeight: 'lighter',    //粗细
                                lineDash: [0, 200],    //虚线样式，表示实线200个单位后再空200个单位。
                                lineDashOffset: 0,    //虚线偏移量，初始为0。
                                fill: 'transparent',    //填充颜色为透明。
                                stroke: '#b44b22',    //描边颜色
                                lineWidth: 1    //描边宽度
                            },
                            keyframeAnimation: {    //关键帧动画配置。
                                duration: 5000,    //动画持续时间
                                loop: false,    // 循环播放动画。
                                keyframes: [    //关键帧数组，定义动画关键帧。
                                    {
                                        percent: 0.7,    //关键帧所占百分比。
                                        style: {   // 该百分比下的样式配置。
                                            fill: 'transparent',    //透明填充。
                                            lineDashOffset: 200,    //虚线偏移量为200，将导致文本内容呈现出不断变化的动画效果。
                                            lineDash: [200, 0]    //虚线样式，将虚线改为实线。
                                        }
                                    }, {
                                        percent: 0.8,    //停顿一段时间，呈现停顿效果。
                                        style: {
                                            fill: 'transparent'    //填充颜色
                                        }
                                    }, {
                                        percent: 1,    //动画结束时的样式。
                                        style: {
                                            fill: '#b44b22'    //填充颜色
                                        }
                                    }]
                            }
                        }]
                }
            }; option && koinlChart.setOption(option);

        </script>
    </body>

</html>
